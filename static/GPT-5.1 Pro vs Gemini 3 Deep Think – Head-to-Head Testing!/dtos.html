<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nebula OS</title>
    <style>
        /* --- CORE VARIABLES --- */
        :root {
            --bg-image: url('https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2072');
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --glass-bg: rgba(15, 23, 42, 0.65);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-highlight: rgba(255, 255, 255, 0.15);
            --shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            --taskbar-h: 48px;
            --win-rad: 10px;
        }

        /* --- GLOBAL RESET & BASE --- */
        * { box-sizing: border-box; user-select: none; outline: none; }
        body {
            margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #000;
            color: var(--text-main);
            overflow: hidden;
            height: 100vh; width: 100vw;
        }

        /* --- WALLPAPER --- */
        #wallpaper {
            position: fixed; inset: 0;
            background-image: var(--bg-image);
            background-size: cover; background-position: center;
            transition: transform 0.3s, filter 0.3s;
            z-index: 0;
        }

        /* --- BOOT SCREEN --- */
        #boot {
            position: fixed; inset: 0;
            background: #000; z-index: 99999;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            transition: opacity 0.8s ease-out;
        }
        .spinner {
            width: 40px; height: 40px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- DESKTOP --- */
        #desktop {
            position: absolute; top: 0; left: 0;
            width: 100%; height: calc(100% - var(--taskbar-h));
            padding: 20px; display: flex; flex-direction: column;
            flex-wrap: wrap; align-content: flex-start; gap: 15px;
            z-index: 1;
        }
        
        .icon {
            width: 80px; height: 90px;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            border-radius: 8px; cursor: pointer;
            transition: 0.2s;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }
        .icon:hover { background: rgba(255,255,255,0.1); backdrop-filter: blur(4px); }
        .icon:active { transform: scale(0.95); }
        .icon svg { width: 38px; height: 38px; margin-bottom: 8px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.4)); }
        .icon span { font-size: 13px; text-align: center; font-weight: 500; }

        /* --- WINDOWS --- */
        .window {
            position: absolute;
            background: var(--glass-bg);
            backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
            border: 1px solid var(--glass-border);
            border-radius: var(--win-rad);
            box-shadow: var(--shadow);
            display: flex; flex-direction: column;
            min-width: 320px; min-height: 200px;
            opacity: 0; transform: scale(0.95);
            transition: opacity 0.2s, transform 0.2s;
            overflow: hidden;
        }
        .window.open { opacity: 1; transform: scale(1); }
        .window.minimized {
            opacity: 0; transform: scale(0.8) translateY(100px);
            pointer-events: none; transition: 0.3s;
        }
        .window.maximized {
            top: 0 !important; left: 0 !important;
            width: 100% !important; height: calc(100% - var(--taskbar-h)) !important;
            border-radius: 0;
        }

        .win-bar {
            height: 40px; background: rgba(255,255,255,0.03);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 12px; border-bottom: 1px solid var(--glass-border);
            cursor: default;
        }
        
        .win-controls { display: flex; gap: 8px; }
        .win-btn { width: 12px; height: 12px; border-radius: 50%; border: none; cursor: pointer; position: relative; }
        .win-btn:hover { filter: brightness(0.8); }
        .cls { background: #ff5f57; } .max { background: #28c840; } .min { background: #febc2e; }

        .win-content { flex: 1; position: relative; overflow: hidden; background: rgba(0,0,0,0.2); }
        
        /* Resize Handles */
        .resizer { position: absolute; z-index: 50; }
        .r-r { right: 0; top: 0; bottom: 10px; width: 6px; cursor: e-resize; }
        .r-b { bottom: 0; left: 0; right: 10px; height: 6px; cursor: n-resize; }
        .r-br { bottom: 0; right: 0; width: 12px; height: 12px; cursor: se-resize; }

        /* --- APPS --- */
        /* Terminal */
        .term { height: 100%; padding: 10px; font-family: 'Consolas', monospace; font-size: 14px; background: #0f0f0f; color: #10b981; overflow-y: auto; }
        .term-out { white-space: pre-wrap; margin-bottom: 5px; }
        .term-in-box { display: flex; gap: 5px; }
        .term-in { background: transparent; border: none; color: #eee; flex: 1; font: inherit; }

        /* Calculator */
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); height: 100%; gap: 1px; background: var(--glass-border); }
        .calc-disp { grid-column: span 4; background: #1e293b; padding: 20px; text-align: right; font-size: 24px; color: #fff; }
        .calc-btn { border: none; background: rgba(30,41,59,0.8); color: #fff; font-size: 16px; cursor: pointer; transition: 0.1s; }
        .calc-btn:hover { background: rgba(255,255,255,0.1); }
        .calc-btn.op { background: rgba(99,102,241,0.2); color: #a5b4fc; }
        .calc-btn.eq { background: var(--accent); }

        /* Notepad */
        .note-area { width: 100%; height: 100%; background: #1e1e1e; border: none; color: #eee; padding: 15px; resize: none; font-family: monospace; }

        /* Code */
        .code-wrap { display: flex; height: 100%; background: #1e1e1e; }
        .code-side { width: 48px; background: #333; display: flex; flex-direction: column; align-items: center; padding-top: 15px; gap: 15px; }
        .code-main { flex: 1; padding: 15px; color: #d4d4d4; font-family: 'Consolas', monospace; font-size: 13px; line-height: 1.5; }
        .kw { color: #569cd6; } .str { color: #ce9178; } .com { color: #6a9955; } .func { color: #dcdcaa; }

        /* Browser */
        .browser-bar { display: flex; gap: 8px; padding: 8px; background: #1e1e1e; border-bottom: 1px solid #333; }
        .url-input { flex: 1; background: #000; border: 1px solid #333; border-radius: 4px; color: #aaa; padding: 4px 10px; font-size: 12px; }
        iframe { width: 100%; height: 100%; border: none; background: #fff; }

        /* --- CONTEXT MENU --- */
        #ctx-menu {
            position: absolute; width: 180px;
            background: rgba(30, 30, 30, 0.95); backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border); border-radius: 6px;
            display: none; flex-direction: column; padding: 4px;
            z-index: 9999; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .ctx-item {
            padding: 8px 12px; font-size: 13px; cursor: pointer; border-radius: 4px; display: flex; align-items: center; gap: 10px;
        }
        .ctx-item:hover { background: var(--accent); color: white; }
        .ctx-div { height: 1px; background: rgba(255,255,255,0.1); margin: 4px 0; }

        /* --- TASKBAR --- */
        #taskbar {
            position: absolute; bottom: 0; width: 100%; height: var(--taskbar-h);
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(20px); border-top: 1px solid var(--glass-border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 10px; z-index: 10000;
        }
        
        .start-btn {
            width: 36px; height: 36px; border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s;
        }
        .start-btn:hover, .start-btn.active { background: rgba(255,255,255,0.1); }
        .start-btn svg { width: 22px; height: 22px; fill: var(--accent); }

        .tasks { flex: 1; display: flex; gap: 4px; margin-left: 15px; height: 100%; align-items: center; }
        .task {
            width: 40px; height: 40px; border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; position: relative; transition: 0.2s;
        }
        .task:hover { background: rgba(255,255,255,0.1); }
        .task.active { background: rgba(255,255,255,0.15); }
        .task.active::after {
            content: ''; position: absolute; bottom: 2px; width: 16px; height: 3px;
            background: var(--accent); border-radius: 2px;
        }
        .task svg { width: 20px; height: 20px; }

        .tray { display: flex; align-items: center; gap: 15px; font-size: 12px; color: var(--text-muted); padding-right: 10px; }

        /* --- START MENU --- */
        #start {
            position: absolute; bottom: 60px; left: 10px;
            width: 320px; background: rgba(30,30,30,0.9);
            backdrop-filter: blur(24px);
            border: 1px solid var(--glass-border); border-radius: 12px;
            padding: 20px; display: flex; flex-direction: column; gap: 15px;
            transform: translateY(20px); opacity: 0; pointer-events: none;
            transition: 0.25s cubic-bezier(0.2, 0.8, 0.2, 1);
            z-index: 10001; box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        }
        #start.open { transform: translateY(0); opacity: 1; pointer-events: auto; }
        
        .start-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .start-item {
            display: flex; flex-direction: column; align-items: center; gap: 8px;
            padding: 10px; border-radius: 8px; cursor: pointer; transition: 0.2s;
        }
        .start-item:hover { background: rgba(255,255,255,0.1); }
        .start-item svg { width: 28px; height: 28px; }
        .start-item span { font-size: 11px; color: #ddd; }

    </style>
</head>
<body>

    <div id="boot">
        <div class="spinner"></div>
        <h2 style="font-weight: 300; letter-spacing: 4px;">NEBULA OS</h2>
        <div style="color: #666; font-size: 12px; margin-top: 10px;">Initializing System...</div>
    </div>

    <div id="wallpaper"></div>

    <div id="ctx-menu">
        <div class="ctx-item" onclick="location.reload()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
            Refresh
        </div>
        <div class="ctx-div"></div>
        <div class="ctx-item" onclick="OS.changeWall()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
            Next Wallpaper
        </div>
        <div class="ctx-item" onclick="document.documentElement.requestFullscreen()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>
            Fullscreen
        </div>
    </div>

    <div id="desktop"></div>

    <div id="start">
        <div style="font-weight: 600; font-size: 14px; opacity: 0.7; margin-left: 5px;">Pinned Apps</div>
        <div class="start-grid" id="start-grid"></div>
        <div style="margin-top: 10px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #6366f1, #a855f7);"></div>
                <div>
                    <div style="font-size: 13px; font-weight: 600;">Guest</div>
                    <div style="font-size: 10px; opacity: 0.6;">Local Account</div>
                </div>
            </div>
            <svg onclick="location.reload()" style="cursor: pointer; width: 18px;" viewBox="0 0 24 24" fill="none" stroke="#ff5f57" stroke-width="2"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"/><line x1="12" y1="2" x2="12" y2="12"/></svg>
        </div>
    </div>

    <div id="taskbar">
        <div class="start-btn" id="start-btn" onclick="OS.toggleStart()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h7v7H3zM14 3h7v7h-7zM14 14h7v7h-7zM3 14h7v7H3z"/></svg>
        </div>
        <div class="tasks" id="tasks"></div>
        <div class="tray">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></svg>
            <div id="clock">12:00</div>
        </div>
    </div>

    <script>
        // --- ICONS ---
        const ICONS = {
            term: '<svg viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>',
            note: '<svg viewBox="0 0 24 24" fill="none" stroke="#fbbf24" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>',
            calc: '<svg viewBox="0 0 24 24" fill="none" stroke="#f472b6" stroke-width="2"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="16" y1="14" x2="16" y2="14"/><line x1="8" y1="14" x2="8" y2="14"/><line x1="12" y1="14" x2="12" y2="14"/><line x1="16" y1="18" x2="16" y2="18"/><line x1="8" y1="18" x2="8" y2="18"/><line x1="12" y1="18" x2="12" y2="18"/></svg>',
            code: '<svg viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>',
            web:  '<svg viewBox="0 0 24 24" fill="none" stroke="#60a5fa" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>',
            set:  '<svg viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>'
        };

        // --- APP DEFINITIONS ---
        const APPS = {
            'term': {
                title: 'Terminal', icon: ICONS.term, w: 600, h: 400,
                html: id => `
                    <div class="term" id="term-${id}" onclick="document.getElementById('in-${id}').focus()">
                        <div class="term-out" id="out-${id}">NebulaOS [Version 2.0.4]<br>(c) 2025 Web Systems. Type 'help'.<br><br></div>
                        <div class="term-in-box">
                            <span style="color:#10b981">root@nebula:~$</span>
                            <input id="in-${id}" class="term-in" autocomplete="off" onkeydown="Logic.term(event, '${id}')">
                        </div>
                    </div>`
            },
            'browser': {
                title: 'Browser', icon: ICONS.web, w: 850, h: 500,
                html: id => `
                    <div style="height:100%; display:flex; flex-direction:column;">
                        <div class="browser-bar">
                            <svg style="width:16px; opacity:0.6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 15l-6-6-6 6"/></svg>
                            <input class="url-input" value="https://en.m.wikipedia.org/wiki/Special:Random" readonly>
                        </div>
                        <iframe src="https://en.m.wikipedia.org/wiki/Special:Random"></iframe>
                    </div>`
            },
            'code': {
                title: 'VS Code', icon: ICONS.code, w: 700, h: 500,
                html: id => `
                    <div class="code-wrap">
                        <div class="code-side">
                             <svg style="width:24px;fill:#666" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/></svg>
                             <svg style="width:24px;fill:#666" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                        </div>
                        <div class="code-main">
                            <div><span class="kw">const</span> <span class="func">OS</span> = {</div>
                            <div style="padding-left:20px"><span class="kw">init</span>() {</div>
                            <div style="padding-left:40px"><span class="kw">this</span>.<span class="func">boot</span>(); <span class="com">// System ready</span></div>
                            <div style="padding-left:20px">}</div>
                            <div>}</div>
                        </div>
                    </div>`
            },
            'calc': {
                title: 'Calculator', icon: ICONS.calc, w: 300, h: 400,
                html: id => `
                    <div class="calc-grid">
                        <div class="calc-disp" id="disp-${id}">0</div>
                        ${['C','/','*','DEL','7','8','9','-','4','5','6','+','1','2','3','EQ','0','.']
                        .map(k => `<button class="calc-btn ${['/','*','-','+'].includes(k)?'op':k==='EQ'?'eq':''}" 
                        style="${k==='0'?'grid-column:span 2':k==='EQ'?'grid-row:span 2':''}" 
                        onclick="Logic.calc('${id}','${k}')">${k==='EQ'?'=':k}</button>`).join('')}
                    </div>`
            },
            'note': {
                title: 'Notepad', icon: ICONS.note, w: 400, h: 300,
                html: id => `<textarea class="note-area" placeholder="Type here..."></textarea>`
            }
        };

        // --- CORE SYSTEM ---
        const OS = {
            zIndex: 100,
            wins: {},

            init() {
                // Boot Animation
                setTimeout(() => {
                    document.getElementById('boot').style.opacity = 0;
                    setTimeout(() => document.getElementById('boot').remove(), 800);
                }, 1500);

                // Clock
                setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}), 1000);

                // Populate Desktop & Start
                const desk = document.getElementById('desktop');
                const start = document.getElementById('start-grid');
                Object.keys(APPS).forEach(key => {
                    const app = APPS[key];
                    // Desktop Icon
                    const icon = document.createElement('div');
                    icon.className = 'icon';
                    icon.innerHTML = `${app.icon}<span>${app.title}</span>`;
                    icon.ondblclick = () => this.open(key);
                    desk.appendChild(icon);
                    // Start Item
                    const item = document.createElement('div');
                    item.className = 'start-item';
                    item.innerHTML = `${app.icon}<span>${app.title}</span>`;
                    item.onclick = () => { this.open(key); this.toggleStart(); };
                    start.appendChild(item);
                });

                // Context Menu
                document.addEventListener('contextmenu', e => {
                    e.preventDefault();
                    const menu = document.getElementById('ctx-menu');
                    menu.style.display = 'flex';
                    menu.style.left = e.clientX + 'px';
                    menu.style.top = e.clientY + 'px';
                });
                document.addEventListener('click', e => {
                    document.getElementById('ctx-menu').style.display = 'none';
                    if(!e.target.closest('#start') && !e.target.closest('#start-btn')) {
                        document.getElementById('start').classList.remove('open');
                        document.getElementById('start-btn').classList.remove('active');
                    }
                });
            },

            open(key) {
                const app = APPS[key];
                const id = Date.now();
                const win = document.createElement('div');
                win.className = 'window';
                win.id = `win-${id}`;
                win.style.width = app.w + 'px';
                win.style.height = app.h + 'px';
                win.style.left = (50 + (Object.keys(this.wins).length*20)%300) + 'px';
                win.style.top = (50 + (Object.keys(this.wins).length*20)%200) + 'px';
                win.style.zIndex = ++this.zIndex;
                
                win.innerHTML = `
                    <div class="win-bar" onmousedown="OS.dragStart(event, '${id}')">
                        <div style="display:flex;gap:8px;align-items:center;font-size:12px">${app.icon.replace('width="38"','width="16"')} ${app.title}</div>
                        <div class="win-controls">
                            <button class="win-btn min" onclick="OS.min('${id}')"></button>
                            <button class="win-btn max" onclick="OS.max('${id}')"></button>
                            <button class="win-btn cls" onclick="OS.close('${id}')"></button>
                        </div>
                    </div>
                    <div class="win-content" onmousedown="OS.focus('${id}')">${app.html(id)}</div>
                    <div class="resizer r-r" onmousedown="OS.resize(event,'${id}','x')"></div>
                    <div class="resizer r-b" onmousedown="OS.resize(event,'${id}','y')"></div>
                    <div class="resizer r-br" onmousedown="OS.resize(event,'${id}','xy')"></div>
                `;

                document.body.appendChild(win);
                this.wins[id] = { el: win, min: false, max: false, prev: {} };
                setTimeout(() => win.classList.add('open'), 10);
                this.addTask(id, app);
            },

            close(id) {
                const win = this.wins[id].el;
                win.style.opacity = 0; win.style.transform = 'scale(0.9)';
                setTimeout(() => win.remove(), 200);
                document.getElementById(`task-${id}`).remove();
                delete this.wins[id];
            },

            min(id) {
                this.wins[id].el.classList.add('minimized');
                this.wins[id].min = true;
                document.getElementById(`task-${id}`).classList.remove('active');
            },

            max(id) {
                const w = this.wins[id];
                if(w.max) {
                    w.el.classList.remove('maximized');
                    Object.assign(w.el.style, w.prev);
                    w.max = false;
                } else {
                    w.prev = { top: w.el.style.top, left: w.el.style.left, width: w.el.style.width, height: w.el.style.height };
                    w.el.classList.add('maximized');
                    w.max = true;
                }
            },

            focus(id) {
                const w = this.wins[id];
                w.el.style.zIndex = ++this.zIndex;
                w.el.classList.remove('minimized');
                w.min = false;
                document.querySelectorAll('.task').forEach(t => t.classList.remove('active'));
                document.getElementById(`task-${id}`).classList.add('active');
            },

            addTask(id, app) {
                const task = document.createElement('div');
                task.className = 'task active';
                task.id = `task-${id}`;
                task.innerHTML = app.icon.replace('width="38"','width="20"');
                task.onclick = () => {
                    if(this.wins[id].min || this.wins[id].el.style.zIndex != this.zIndex) this.focus(id);
                    else this.min(id);
                };
                document.getElementById('tasks').appendChild(task);
            },

            dragStart(e, id) {
                if(this.wins[id].max) return;
                this.focus(id);
                const win = this.wins[id].el;
                const shiftX = e.clientX - win.getBoundingClientRect().left;
                const shiftY = e.clientY - win.getBoundingClientRect().top;
                
                // Fix iframe swallowing mouse events
                const cover = document.createElement('div');
                cover.style.cssText = 'position:fixed;inset:0;z-index:99999;cursor:grabbing;';
                document.body.appendChild(cover);

                const move = e => {
                    win.style.left = (e.clientX - shiftX) + 'px';
                    win.style.top = Math.max(0, e.clientY - shiftY) + 'px';
                };
                const stop = () => {
                    document.removeEventListener('mousemove', move);
                    document.removeEventListener('mouseup', stop);
                    cover.remove();
                };
                document.addEventListener('mousemove', move);
                document.addEventListener('mouseup', stop);
            },

            resize(e, id, type) {
                e.stopPropagation();
                const win = this.wins[id].el;
                const startX = e.clientX, startY = e.clientY;
                const startW = parseInt(getComputedStyle(win).width), startH = parseInt(getComputedStyle(win).height);
                
                const cover = document.createElement('div');
                cover.style.cssText = 'position:fixed;inset:0;z-index:99999;cursor:se-resize;';
                document.body.appendChild(cover);

                const move = e => {
                    if(type.includes('x')) win.style.width = (startW + e.clientX - startX) + 'px';
                    if(type.includes('y')) win.style.height = (startH + e.clientY - startY) + 'px';
                };
                const stop = () => {
                    document.removeEventListener('mousemove', move);
                    document.removeEventListener('mouseup', stop);
                    cover.remove();
                };
                document.addEventListener('mousemove', move);
                document.addEventListener('mouseup', stop);
            },

            toggleStart() {
                const s = document.getElementById('start');
                s.classList.toggle('open');
                document.getElementById('start-btn').classList.toggle('active');
            },
            
            changeWall() {
                const urls = [
                    'https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2072',
                    'https://images.unsplash.com/photo-1506318137071-a8bcbf6755dd?q=80&w=2070',
                    'https://images.unsplash.com/photo-1536566482680-fca31930a0bd?q=80&w=1974'
                ];
                document.getElementById('wallpaper').style.backgroundImage = `url(${urls[Math.floor(Math.random()*urls.length)]})`;
            }
        };

        const Logic = {
            term(e, id) {
                if(e.key === 'Enter') {
                    const val = e.target.value.trim();
                    const out = document.getElementById(`out-${id}`);
                    out.innerHTML += `<div><span style="color:#10b981">root@nebula:~$</span> ${val}</div>`;
                    if(val === 'help') out.innerHTML += `<div style="color:#aaa">cmds: help, date, clear, reboot</div>`;
                    else if(val === 'date') out.innerHTML += `<div>${new Date().toString()}</div>`;
                    else if(val === 'clear') out.innerHTML = '';
                    else if(val === 'reboot') location.reload();
                    else if(val) out.innerHTML += `<div style="color:#f87171">Command not found</div>`;
                    e.target.value = '';
                    out.parentElement.scrollTop = out.parentElement.scrollHeight;
                }
            },
            calc(id, key) {
                const d = document.getElementById(`disp-${id}`);
                if(key === 'C') d.innerText = '0';
                else if(key === 'DEL') d.innerText = d.innerText.slice(0,-1) || '0';
                else if(key === 'EQ') { try { d.innerText = eval(d.innerText); } catch { d.innerText = 'Err'; } }
                else d.innerText = d.innerText==='0' ? key : d.innerText+key;
            }
        };

        OS.init();
    </script>
</body>
</html>
